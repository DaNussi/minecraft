/* groovylint-disable CompileStatic, NestedBlockDepth, VariableTypeRequired */

LinkedList<String> changedEggFiles = [] as LinkedList<String>
def eggConfigs = [] as LinkedList<Map>
def eggTestingStages = [:]

Map<String, Integer> eggIds = [:]

// store the resolved pelican user object (id/username/email) for downstream stages
def PELICAN_USER = [:]

pipeline {
    agent any

    environment {
        PELICAN_BASE_URL = credentials('jenkins-pelican-base-url')
        PELICAN_USER_EMAIL    = credentials('jenkins-pelican-user')
        PELICAN_TOKEN = credentials('jenkins-pelican-token')
    }

    stages {
        stage('Validate environment variables') {
            steps {
                script {
                    if (PELICAN_BASE_URL?.trim()?.length() == 0) {
                        error 'PELICAN_BASE_URL parameter is required'
                    }
                    if (PELICAN_USER_EMAIL?.trim()?.length() == 0) {
                        error 'PELICAN_USER_EMAIL parameter is required'
                    }
                    if (PELICAN_TOKEN?.trim()?.length() == 0) {
                        error 'PELICAN_TOKEN parameter is required'

                    }
                }
            }
        }

        stage('Resolve pelican user id') {
            steps {
                script {
                    def response = sh(
                        script: 'curl -s -o .jenkins/user-request.json -w "%{http_code}\n" -X GET -H "Accept: application/json" -H "Authorization: Bearer $PELICAN_TOKEN" -- $PELICAN_BASE_URL/users',
                        returnStdout: true
                    ).trim()

                    if(response.startsWith('2')) {
                        echo 'Successfully retrieved pelican users'
                        def usersJson = readJSON file: '.jenkins/user-request.json'
                        def pelicanUsers = usersJson['data'].collect { userJson ->
                            [
                                id: userJson['attributes']['id'],
                                username: userJson['attributes']['username'],
                                email: userJson['attributes']['email']
                            ]
                        }

                        echo "Found ${pelicanUsers.size()} users"

                        // Match by email (case-insensitive), fall back to username if not found.
                        def target = PELICAN_USER_EMAIL?.trim()?.toLowerCase()
                        def matchedUsers = pelicanUsers.findAll { u ->
                            (u.email ?: '').toLowerCase() == target
                        }

                        if (matchedUsers.size() == 1) {
                            def pelicanUser = matchedUsers[0]
                            PELICAN_USER = pelicanUser
                            echo "Resolved Pelican user id: ${pelicanUser.id} for user: ${pelicanUser.username} (${pelicanUser.email})"
                        } else if (matchedUsers.size() > 1) {
                            error "Multiple Pelican users matched. Please ensure the PELICAN_USER_EMAIL is correct and unique."
                        } else {
                            error "No Pelican user matched. Please ensure PELICAN_USER_EMAIL exists in the pelican panel."
                        }


                    } else {
                        error "Failed to retrieve pelican users, response code: ${response}"
                    }
                }
            }
        }

        stage('Detect egg changes') {
            steps {
                script {
                    def targetBranch = env.CHANGE_TARGET ?: 'main'
                    echo "Comparing changes against branch: origin/${targetBranch}"

                    sh 'git show-ref'

                    def eggsConfig = readJSON file: '.jenkins/eggs.json'

                    changedEggFiles = []
                    eggConfigs += eggsConfig['eggs']

                    eggConfigs.each { eggConfig ->
                        echo "Found egg configuration: ${eggConfig}"

                        String currentChangedEggDiffs = sh(
                            script: "git diff --name-only origin/${targetBranch} -- ${eggConfig['path']}",
                            returnStdout: true
                        )
                        .trim()

                        if (!currentChangedEggDiffs.isEmpty()) {
                            def currentChangedEggFiles = currentChangedEggDiffs
                                .split('\n')
                                .findAll { file -> file.endsWith('.json') }
                                //.findAll { file -> file.endsWith('.json') && fileExists(file) }

                            echo "Detected ${currentChangedEggFiles.size()} changed egg files in path: ${eggConfig['path']}"

                            changedEggFiles += currentChangedEggFiles
                        } else {
                            echo "No changes detected in egg path: ${eggConfig['path']}"
                        }
                    }

                    echo 'Changed egg file:'
                    changedEggFiles.each { changedEggFile ->
                        echo changedEggFile
                    }
                }
            }
        }

        stage('Testing egg\'s'){
            steps {
                script {
                    for (int pi = 0; pi < changedEggFiles.size(); pi++) {
                        String eggFile = changedEggFiles[pi]
                        eggTestingStages["Testing Egg ${eggFile}"] = testEgg(eggFile, eggIds, PELICAN_USER.id as Integer)
                        break //for testing only
                    }
                    parallel eggTestingStages
                }
            }
        }
    }
}


def testEgg(String eggFile, Map<String, Integer> eggIds,  Integer userId) {
    return {
        stage("Testing Egg ${eggFile}") {

            stage("Updating Egg UUID") {
                script {
                    def eggJson = readJSON file: eggFile

                    def eggUUID = getEggUuid(eggFile)

                    eggJson['uuid'] = eggUUID

                    writeJSON file: eggFile, json: eggJson

                    echo "Set Egg ${eggFile} uuid to ${eggUUID}"
                }
            }

            stage("Importing Egg") {
                script {
                    echo "Importing egg file: ${eggFile}"

                    def response_file = eggFile.replace('.json', '.import.json')

                    def response_status = sh(
                            script: """
                                curl -s -X POST --data-binary "@${eggFile}" -o "${response_file}" -w '%{http_code}\\n' -H 'Accept: application/json' -H "Authorization: Bearer ${env.PELICAN_TOKEN}" -- "${env.PELICAN_BASE_URL}/eggs/import"
                            """,
                            returnStdout: true
                    ).trim()

                    if(response_status.startsWith('2')) {
                        def response = readJSON file: response_file
                        def eggId = response['attributes']['id'] as int

                        eggIds[eggFile] = eggId

                        echo "Successfully imported egg ${eggFile} id: ${eggId}"

                    } else {
                        error "Failed to import egg ${eggFile}, response code: ${response_status}"
                    }
                }
            }

            stage("Create Server") {
                script {

                    def eggUUID = getEggUuid(eggFile)

                    def egg = readJSON file: eggFile

                    def serverJson = """
                    {
                      "external_id": "${eggUUID}",
                      "name": "Jenkins CI/CD - ${eggUUID}",
                      "description": "${env.BUILD_URL}",
                      "user": ${userId},
                      "egg": ${eggIds[eggFile]},
                      "environment": [],
                      "skip_scripts": false,
                      "oom_killer": false,
                      "start_on_completion": true,
                      "limits": {
                        "memory": 10240,
                        "disk": 10240,
                        "swap": -1,
                        "io": 1000,
                        "cpu": 800
                      },
                      "feature_limits": {
                        "databases": 0,
                        "allocations": 0,
                        "backups": 0
                      },
                      "allocation": {},
                      "deploy": {
                        "locations": [],
                        "tags": [
                          "jenkins"
                        ],
                        "dedicated_ip": false,
                        "port_range": [
                            "25600","25601","25602","25603","25604",
                            "25605","25606","25607","25608","25609",
                            "25610","25611","25612","25613","25614",
                            "25615","25616","25617","25618","25619",
                            "25620","25621","25622","25623","25624",
                            "25625","25626","25627","25628","25629",
                            "25630","25631","25632","25633","25634",
                            "25635","25636","25637","25638","25639",
                            "25640","25641","25642","25643","25644",
                            "25645","25646","25647","25648","25649",
                            "25650","25651","25652","25653","25654",
                            "25655","25656","25657","25658","25659",
                            "25660","25661","25662","25663","25664",
                            "25665","25666","25667","25668","25669"
                        ]
                      }
                    }""".stripIndent().toString()

                    echo serverJson

                    String server_file = eggFile.replace('.json', '.server.json')
                    writeFile file: server_file, text: serverJson, encoding: "UTF-8"
                    echo "Created server create request data ${server_file}"

                    def f = sh "cat ${server_file}"
                    echo f

                    def response_file = eggFile.replace('.json', '.create.json')

                    def request = """
                                curl -s -X POST --data-binary "@${server_file}"  -o "${response_file}" -w '%{http_code}\\n' -H 'Accept: application/json' -H "Authorization: Bearer ${env.PELICAN_TOKEN}" -- "${env.PELICAN_BASE_URL}/servers"
                        """.toString()
                    echo request

                    def response = sh(
                            script: request,
                            returnStdout: true
                    ).trim()

                    if(response.startsWith('2')) {
                        def responseJson = readJSON file: response_file
                        def serverId = responseJson['attributes']['id']

                        echo "Successfully created server ${serverId} ${eggFile}"

                    } else {
                        def responseText = readFile file: response_file

                        echo "Failed to create server ${eggFile}, response code: ${response}"
                        echo "Failure Response:\n${responseText}"

                        error "Failed to create server ${eggFile}, response code: ${response}"
                    }


                }
            }


            stage("Deleting Egg") {
                script {
                    echo "Deleting egg: ${eggFile}"

                    def response_file = eggFile.replace('.json', '.delete.json')

                    def eggUUID = getEggUuid(eggFile)

                    def response = sh(
                            script: """
                                curl -s -X DELETE -o "${response_file}" -w '%{http_code}\\n' -H 'Accept: application/json' -H "Authorization: Bearer ${env.PELICAN_TOKEN}" -- "${env.PELICAN_BASE_URL}/eggs/${eggUUID}/uuid"
                            """,
                            returnStdout: true
                    ).trim()

                    if(response.startsWith('2')) {
                        echo "Successfully deleted egg ${eggFile}"

                    } else {
                        error "Failed to delete egg ${eggFile} with uuid ${eggUUID}, response code: ${response}"
                    }
                }
            }
        }
    }
}

def getEggUuid(String eggFile) {
    String gitUUID = env.GIT_COMMIT as String
    String fileUUID = eggFile
    String eggUUID = UUID.nameUUIDFromBytes((fileUUID + '@' + gitUUID).getBytes()).toString()
    return eggUUID
}