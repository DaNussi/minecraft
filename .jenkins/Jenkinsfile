/* groovylint-disable CompileStatic, NestedBlockDepth, VariableTypeRequired */

pipeline {
    agent any

    stages {
        stage('Detect egg changes') {
            steps {
                script {
                    def targetBranch = env.CHANGE_TARGET ?: 'main'
                    echo "Comparing changes against branch: origin/${targetBranch}"

                    sh 'git show-ref'

                    def eggsConfig = readJSON file: '.jenkins/eggs.json'

                    def changedEggFiles = [] as LinkedList<String>

                    def eggConfigs = eggsConfig['eggs'] ?: [] as LinkedList<Map>

                    eggConfigs.each { eggConfig ->
                        echo "Found egg configuration: ${eggConfig}"

                        String currentChangedEggDiffs = sh(
                            script: "git diff --name-only origin/${targetBranch} -- ${eggConfig['path']}",
                            returnStdout: true
                        )
                        .trim()
                        echo "Current changed egg diffs:\n${currentChangedEggDiffs}"

                        /*
                        if (currentChangedEggDiffs) {
                            def currentChangedEggFiles = currentChangedEggDiffs
                                .split('\n')
                                .findAll { file -> file.endsWith('.json') && fileExists(file) }

                            echo "Detected ${currentChangedEggFiles.size()} changed egg files in path: ${eggConfig['path']}"

                            changedEggFiles += currentChangedEggFiles
                        } else {
                            echo "No changes detected in egg path: ${eggConfig['path']}"
                        }
                        */
                    }

                    for (int ci = 0; ci < changedEggFiles.size(); ci++) {
                        echo "Changed egg file: ${changedEggFiles[ci]}"
                    }

                    /*
                    def parallelStages = [:]
                    */
                }
            }
        }
    }
}
