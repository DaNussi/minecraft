/* groovylint-disable CompileStatic, NestedBlockDepth, VariableTypeRequired */

pipeline {
    agent any

    stages {
        stage('Detect egg changes') {
            steps {
                script {
                    def targetBranch = env.CHANGE_TARGET ?: 'main'
                    echo "Comparing changes against branch: origin/${targetBranch} (resolving ref)"

                    // Try fetching the specific branch; fall back to a full fetch if needed,
                    // then pick a usable ref (prefer origin/<branch> if present).
                    def baseRef = sh(script: '''
                            set -e
                            if git fetch origin ${targetBranch}; then
                                :
                            else
                                git fetch origin || true
                            fi
                            if git rev-parse --verify --quiet origin/${targetBranch} >/dev/null; then
                                echo origin/${targetBranch}
                            else
                                echo ${targetBranch}
                            fi
                    ''', returnStdout: true).trim()

                    echo "Resolved base ref: ${baseRef}"

                    def eggsConfig = readJSON file: '.jenkins/eggs.json'

                    def changedEggFiles = []

                    for (eggConfig in eggsConfig['eggs']) {
                        echo "Found egg configuration: ${eggConfig}"

                        def currentChangedEggFiles = sh(
                            script: "git diff --name-only ${baseRef} -- ${eggConfig['path']}", 
                            returnStdout: true
                        )
                        .trim()
                        .split('\n')
                        .findAll { file ->file.endsWith('.json') && fileExists(file) }

                        changedEggFiles.addAll(currentChangedEggFiles)
                    }


                    for (changedEggFile in changedEggFiles) {
                        echo "Detected changed egg file: ${changedEggFile}"
                    }

                    /*

                    def changeLog = sh(
                        script: "git diff --name-only origin/${targetBranch}...HEAD",
                        returnStdout: true
                    ).trim()

                    def jsonFiles = changeLog.split('\n').findAll { file ->
                        file.endsWith('.json') && fileExists(file)
                    }

                    if (!jsonFiles) {
                        echo "No JSON files to test."
                        return // Exit if nothing to do
                    }

                    def parallelStages = [:]
                    */
                }
            }
        }
    }
}
